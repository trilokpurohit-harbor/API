# Harbor Point API Developer Guide

Welcome to the team! This guide captures the project conventions, runtime expectations, and day-to-day developer workflows for the NestJS API.

## Stack At A Glance

- **Runtime**: Node.js 22.20.0 LTS
- **Package manager**: pnpm 10.15.1 (all scripts assume pnpm)
- **Framework**: NestJS 11 with TypeScript
- **ORM / DB**: Prisma targeting PostgreSQL
- **Documentation**: Swagger UI served by the application

Make sure you install the exact Node and pnpm versions (e.g. via fnm, nvm, or Volta) to avoid dependency drift.

## Environment Setup

- Copy the example environment file: `cp .env.example .env` (or `Copy-Item` / manual copy on Windows).
- Update `.env` with your local PostgreSQL credentials and secrets:
    - `DATABASE_URL` / `SHADOW_DATABASE_URL` should match your databases.
    - Keep the seed users (`MASTER_USER_*`) and `JWT_SECRET` aligned with the credentials you plan to use.
- Do not commit your `.env`; the checked-in `.env.example` remains the canonical template when values change.

## Project Layout & Conventions

The codebase follows a layered structure. Keep new code aligned with these conventions.

```
src/
├─ app.module.ts             # Root Nest module wiring the feature modules
├─ common/                   # Cross-cutting helpers shared across modules
│  ├─ enums/                 # Enumerations (e.g., RoleName)
│  ├─ filters/               # Global exception filters
│  ├─ guards/                # Authorization and access guards
│  └─ validators/            # Custom validation decorators/utilities
├─ core/
│  └─ database/              # Canonical source for all Prisma artifacts (see below)
├─ infrastructure/
│  └─ prisma/                # PrismaService + PrismaModule bootstrapping DB access
├─ modules/                  # Feature modules grouped by domain
│  ├─ auth/                  # Authentication flows, guard, and DTOs
│  ├─ role/                  # Role CRUD with soft-delete and audit fields
│  └─ user/                  # User lifecycle and role assignment APIs
└─ main.ts                   # Application entry point (global pipes, filters, Swagger)
```

**General rules**

- Feature code belongs under `src/modules/<feature>` with controllers, services, and a `dto/` folder for request contracts.
- Reusable concerns (guards, filters, enums) live under `src/common`.
- Infrastructure integrations (database clients, external drivers) stay under `src/infrastructure`.
- File names follow kebab-case, class names remain PascalCase, and DTOs end with `Dto`.
- Keep business logic inside services; controllers should orchestrate requests/responses only.

## `/src/core/database/` Deep Dive

This folder is the single source of truth for our Prisma setup.

- `schema/` holds modularized Prisma schema fragments (`schema.prisma` as the entry point plus domain-specific files like `user.prisma`, `role.prisma`, `userRole.prisma`).
- `migrations/` contains time-stamped migration directories generated by Prisma. Do not edit existing migrations; create new ones when schema changes are required.
- `seed/index.ts` seeds baseline data (core roles and default users). Run it with `pnpm prisma:seed` after configuring environment variables.
- `prisma.config.ts` points Prisma CLI to these folders, so CLI commands (migrate, generate) pick up the custom paths automatically.

> **Database**: All environments use PostgreSQL. Define the `DATABASE_URL` (and any seed-specific variables such as `MASTER_USER_EMAIL`) inside `.env` when running locally.

## Running The Application

### Visual Studio Code (recommended)

1. Open the workspace in VS Code.
2. If dependencies are not installed yet, run `pnpm install` in the project root.
3. Press `F5`. The preconfigured launch task builds the project, starts the Nest server, and opens Swagger docs in your browser (`/api`).

### Command line

```bash
pnpm install          # first run only
pnpm run start:dev    # watch mode with hot reload
```

The server listens on the port specified by `PORT` in `.env` (defaults to `3000`). Swagger UI is available at `http://localhost:<PORT>/api` once the app starts.

## Database Tasks

| Task                   | Command                |
| ---------------------- | ---------------------- |
| Apply migrations       | `pnpm prisma:deploy`   |
| Create new migration   | `pnpm prisma:migrate`  |
| Generate Prisma client | `pnpm prisma:generate` |
| Seed baseline data     | `pnpm prisma:seed`     |
| Prisma studio          | `pnpm prisma:studio`   |
| Reset database         | `pnpm prisma:reset`    |

Always run migrations before seeding to ensure the schema matches the code.

- prisma seed will run automatically after migrations during `pnpm prisma:reset`.

## Coding Workflow Checklist

1. Install dependencies (`pnpm install`) after pulling new changes.
2. Keep `.env` updated with database credentials.
3. Use the provided guards, filters, and DTO patterns when adding endpoints.
4. Add unit/e2e tests in `test/` for new features.
5. Run `pnpm run lint` and `pnpm run test` before opening a pull request.

## Need Help?

- Reach out in the project channel for environment issues.
- Consult the Swagger UI for live request/response samples.
- Review existing modules under `src/modules` for implementation patterns.
